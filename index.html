<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Kanji Snap</title>

  <link rel="manifest" href="manifest.webmanifest">
  <meta name="theme-color" content="#0b1220">
  <link rel="apple-touch-icon" href="apple-touch-icon.png">

  <style>
    @font-face{
      font-family:"KanjiFont";
      src:url("./fonts/my-font.ttf") format("truetype");
      font-display:swap;
    }

    :root{
      --bg:#0b1220;
      --border:rgba(233,238,252,.14);
      --paper:#ffffff;
      --paperBorder:rgba(0,0,0,.15);
      --ink:#000;
      --muted:#a8b3cf;
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      min-height:100vh;
      background:var(--bg);
      font-family:system-ui,-apple-system,Segoe UI,Roboto;
      color:#e9eefc;
      display:flex;
      justify-content:center;
      padding:16px;
    }

    .wrap{width:min(680px,100%)}
    .card{
      background:#111a2e;
      border:1px solid var(--border);
      border-radius:18px;
      padding:16px;
    }

    .tabs{display:flex;gap:8px;margin-bottom:12px}
    .tab{
      padding:8px 12px;
      border-radius:999px;
      border:1px solid var(--border);
      background:none;
      color:#e9eefc;
      font-weight:700;
      cursor:pointer;
    }
    .tab.active{background:rgba(233,238,252,.08)}

    .view{display:none}
    .view.active{display:block}

    .prompt{
      background:var(--paper);
      border:2px solid var(--paperBorder);
      border-radius:16px;
      min-height:160px;
      display:flex;
      align-items:center;
      justify-content:center;
      cursor:pointer;
      transition:background-color .15s;
    }
    .prompt.correct{background:#d1fae5;border-color:#22c55e}
    .prompt.wrong{background:#fee2e2;border-color:#ef4444}

    .kanjiText{
      font-family:"KanjiFont",sans-serif;
      font-size:96px;
      color:var(--ink);
    }

    .choices{
      margin-top:12px;
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:10px;
    }

    button.choice{
      background:var(--paper);
      border:2px solid var(--paperBorder);
      border-radius:16px;
      min-height:140px;
      cursor:pointer;
      display:flex;
      align-items:center;
      justify-content:center;
      position:relative;
      transition:background-color .15s;
    }

    button.choice.correct{
      background:#d1fae5;
      border-color:#22c55e;
    }
    button.choice.wrong{
      background:#fee2e2;
      border-color:#ef4444;
    }

    .meaningFallback{
      font-size:22px;
      font-weight:800;
      color:var(--ink);
      text-align:center;
    }

    .dictTile{
      background:var(--paper);
      border:2px solid var(--paperBorder);
      border-radius:16px;
      padding:14px;
      color:var(--ink);
    }

    pre{
      background:#f3f4f6;
      padding:10px;
      border-radius:10px;
      font-size:12px;
      overflow:auto;
      max-height:240px;
    }

    .pill{font-size:12px;color:var(--muted)}
  </style>
</head>

<body>
<div class="wrap">
  <div class="card">

    <div class="tabs">
      <button class="tab active" id="tabHome">Home</button>
      <button class="tab" id="tabGame">Game</button>
    </div>

    <section class="view active" id="viewHome">
      <button id="startGame">Start Meaning Quiz</button>
    </section>

    <section class="view" id="viewGame">
      <div class="prompt" id="prompt">
        <div class="kanjiText" id="kanjiPrompt">？</div>
      </div>

      <div class="choices" id="choices"></div>
    </section>

  </div>
</div>

<script>
if("serviceWorker" in navigator){
  navigator.serviceWorker.register("./sw.js");
}

const GRADE_FILES={
  1:"./grade-1.json",
  2:"./grade-2.json",
  3:"./grade-3.json"
};

const kanjiMap=new Map();
const loadedGrades=new Set();

async function loadGrade(g){
  if(loadedGrades.has(g))return;
  const res=await fetch(GRADE_FILES[g]);
  const arr=await res.json();
  for(const r of arr){
    kanjiMap.set(r.kanji,{
      id:r.kanji,
      grade:r.grade,
      on:r.onyomi||[],
      kun:r.kunyomi||[],
      meaningKey:(r.label||"みてい"),
      raw:r
    });
  }
  loadedGrades.add(g);
}

let pool=[],current=null,locked=false,peek=false;

function shuffle(a){
  for(let i=a.length-1;i>0;i--){
    const j=Math.floor(Math.random()*(i+1));
    [a[i],a[j]]=[a[j],a[i]];
  }
  return a;
}

function renderChoices(opts){
  choices.innerHTML="";
  choices.style.display="grid";
  opts.forEach(o=>{
    const b=document.createElement("button");
    b.className="choice";
    b.dataset.ok=o.ok?"1":"0";
    b.textContent=o.meaning;
    b.onclick=()=>choose(b);
    choices.appendChild(b);
  });
}

function renderDict(k){
  choices.innerHTML="";
  choices.style.display="block";
  const d=document.createElement("div");
  d.className="dictTile";
  d.innerHTML=`<strong>${k.id}</strong><br>
    音: ${k.on.join("、")}<br>
    訓: ${k.kun.join("、")}
    <pre>${JSON.stringify(k.raw,null,2)}</pre>`;
  choices.appendChild(d);
}

function pick(){
  locked=false;peek=false;
  prompt.classList.remove("correct","wrong");

  current=pool[Math.floor(Math.random()*pool.length)];
  kanjiPrompt.textContent=current.id;

  const wrongs=shuffle(pool.filter(k=>k.id!==current.id)).slice(0,3);
  const opts=shuffle([
    {meaning:current.meaningKey,ok:true},
    ...wrongs.map(w=>({meaning:w.meaningKey,ok:false}))
  ]);
  renderChoices(opts);
}

function choose(btn){
  if(locked||peek)return;
  locked=true;

  const ok=btn.dataset.ok==="1";
  if(ok){
    btn.classList.add("correct");
    prompt.classList.add("correct");
  }else{
    btn.classList.add("wrong");
    prompt.classList.add("wrong");
    [...document.querySelectorAll(".choice")]
      .find(b=>b.dataset.ok==="1")
      ?.classList.add("correct");
  }
  setTimeout(pick,900);
}

prompt.onclick=()=>{
  if(!current)return;
  peek=!peek;
  peek?renderDict(current):pick();
};

startGame.onclick=async()=>{
  await loadGrade(1);
  pool=[...kanjiMap.values()];
  viewHome.classList.remove("active");
  viewGame.classList.add("active");
  pick();
};
</script>
</body>
</html>
